#!/usr/bin/perl
use strict;
use warnings;
use Getopt::Long qw(GetOptionsFromArray);

my $usage = "Usage: $0 [--wired] [TEST_URL]\n";

sub main(@){
  my $wired;
  GetOptionsFromArray(\@_, "wired" => \$wired);

  my $url = shift;
  die $usage if @_ > 0;
  if(defined $url){
    my $test = `execPing --attempts=1 $url --test`;
    if($test =~ /^ok: \Q$url\E$/){
      print "'$url' test succeeded, skipping wauto\n";
      exit 0;
    }
  }
  my $wautoPidfile = '/tmp/wauto-pidfile';
  if(-e $wautoPidfile){
    system "kill -9 `cat $wautoPidfile` >/dev/null 2>/dev/null";
  }
  system "echo $$ > $wautoPidfile";

  if($wired){
    system "wired";
    exit if $? == 0;
  }

  system "wconnect", "-d";
  my $ssid = `wguessid`;
  if($? == 0){
    chomp $ssid;
    print "SSID: $ssid\n";
    system "wconnect", $ssid;
  }else{
    die "No suitable ssid found\n";
  }
}

&main(@ARGV);
